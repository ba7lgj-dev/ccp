<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ba7lgj.ccp.core.mapper.CcpMiniUserMapper">

    <resultMap id="CcpMiniUserResult" type="org.ba7lgj.ccp.common.domain.MiniUser">
        <id    property="id" column="id"/>
        <result property="openId" column="open_id"/>
        <result property="unionId" column="union_id"/>
        <result property="nickName" column="nick_name"/>
        <result property="avatarUrl" column="avatar_url"/>
        <result property="phone" column="phone"/>
        <result property="realName" column="real_name"/>
        <result property="idCardName" column="id_card_name"/>
        <result property="idCardNumber" column="id_card_number"/>
        <result property="faceImageUrl" column="face_image_url"/>
        <result property="faceVerifyResult" column="face_verify_result"/>
        <result property="gender" column="gender"/>
        <result property="status" column="status"/>
        <result property="realAuthStatus" column="real_auth_status"/>
        <result property="realAuthFailReason" column="real_auth_fail_reason"/>
        <result property="realAuthReviewBy" column="real_auth_review_by"/>
        <result property="realAuthReviewTime" column="real_auth_review_time"/>
        <result property="adminRemark" column="admin_remark"/>
        <result property="lastActiveTime" column="last_active_time"/>
        <result property="onlineStatus" column="online_status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <resultMap id="RealAuthListResult" type="org.ba7lgj.ccp.core.domain.vo.CcpUserRealAuthListVO">
        <id property="id" column="id" />
        <result property="nickName" column="nick_name" />
        <result property="avatarUrl" column="avatar_url" />
        <result property="phone" column="phone" />
        <result property="realName" column="real_name" />
        <result property="idCardNumber" column="id_card_number" />
        <result property="realAuthStatus" column="real_auth_status" />
        <result property="realAuthFailReason" column="real_auth_fail_reason" />
        <result property="realAuthReviewByName" column="reviewer_name" />
        <result property="realAuthReviewTime" column="real_auth_review_time" />
        <result property="createTime" column="create_time" />
    </resultMap>

    <resultMap id="RealAuthDetailResult" type="org.ba7lgj.ccp.core.domain.vo.CcpUserRealAuthDetailVO">
        <id property="id" column="id" />
        <result property="nickName" column="nick_name" />
        <result property="avatarUrl" column="avatar_url" />
        <result property="phone" column="phone" />
        <result property="realName" column="real_name" />
        <result property="idCardNumber" column="id_card_number" />
        <result property="faceImageUrl" column="face_image_url" />
        <result property="adminRemark" column="admin_remark" />
        <result property="realAuthStatus" column="real_auth_status" />
        <result property="realAuthFailReason" column="real_auth_fail_reason" />
        <result property="realAuthReviewByName" column="reviewer_name" />
        <result property="realAuthReviewTime" column="real_auth_review_time" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <sql id="Base_Column_List">
        id, open_id, union_id, nick_name, avatar_url, phone, real_name, id_card_name, id_card_number,
        face_image_url, face_verify_result, gender, status, real_auth_status, real_auth_fail_reason,
        real_auth_review_by, real_auth_review_time, admin_remark, last_active_time, online_status, create_time, update_time
    </sql>

    <select id="selectCcpMiniUserById" parameterType="long" resultMap="CcpMiniUserResult">
        select <include refid="Base_Column_List"/>
        from ccp_mini_user
        where id = #{id}
    </select>

    <select id="selectCcpMiniUserList" parameterType="org.ba7lgj.ccp.common.domain.MiniUser" resultMap="CcpMiniUserResult">
        select <include refid="Base_Column_List"/>
        from ccp_mini_user
        <where>
            <if test="nickName != null and nickName != ''">
                and nick_name like concat('%', #{nickName}, '%')
            </if>
            <if test="phone != null and phone != ''">
                and phone like concat('%', #{phone}, '%')
            </if>
            <if test="realName != null and realName != ''">
                and real_name like concat('%', #{realName}, '%')
            </if>
            <if test="realAuthStatus != null">
                and real_auth_status = #{realAuthStatus}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="onlineStatus != null">
                and online_status = #{onlineStatus}
            </if>
            <if test="createTimeBegin != null">
                and create_time &gt;= #{createTimeBegin}
            </if>
            <if test="createTimeEnd != null">
                and create_time &lt;= #{createTimeEnd}
            </if>
        </where>
        order by create_time desc
    </select>

    <select id="selectUserRealAuthList" parameterType="org.ba7lgj.ccp.common.dto.CcpUserRealAuthQueryDTO" resultMap="RealAuthListResult">
        select u.id, u.nick_name, u.avatar_url, u.phone, u.real_name, u.id_card_number,
               u.real_auth_status, u.real_auth_fail_reason, u.real_auth_review_time, u.create_time,
               su.nick_name as reviewer_name
        from ccp_mini_user u
        left join sys_user su on su.user_id = u.real_auth_review_by
        <where>
            <if test="nickName != null and nickName != ''">
                and u.nick_name like concat('%', #{nickName}, '%')
            </if>
            <if test="phone != null and phone != ''">
                and u.phone like concat('%', #{phone}, '%')
            </if>
            <if test="realName != null and realName != ''">
                and u.real_name like concat('%', #{realName}, '%')
            </if>
            <if test="realAuthStatus != null">
                and u.real_auth_status = #{realAuthStatus}
            </if>
            <if test="beginTime != null and beginTime != ''">
                and date_format(u.create_time, '%Y-%m-%d') &gt;= #{beginTime}
            </if>
            <if test="endTime != null and endTime != ''">
                and date_format(u.create_time, '%Y-%m-%d') &lt;= #{endTime}
            </if>
        </where>
        order by u.create_time desc
    </select>

    <select id="selectUserRealAuthDetail" parameterType="long" resultMap="RealAuthDetailResult">
        select u.id, u.nick_name, u.avatar_url, u.phone, u.real_name, u.id_card_number, u.face_image_url, u.admin_remark,
               u.real_auth_status, u.real_auth_fail_reason, u.real_auth_review_time, u.create_time, u.update_time,
               su.nick_name as reviewer_name
        from ccp_mini_user u
                 left join sys_user su on su.user_id = u.real_auth_review_by
        where u.id = #{userId}
    </select>

    <update id="updateCcpMiniUser" parameterType="org.ba7lgj.ccp.common.domain.MiniUser">
        update ccp_mini_user
        <set>
            <if test="nickName != null">nick_name = #{nickName},</if>
            <if test="avatarUrl != null">avatar_url = #{avatarUrl},</if>
            <if test="phone != null">phone = #{phone},</if>
            <if test="realName != null">real_name = #{realName},</if>
            <if test="idCardName != null">id_card_name = #{idCardName},</if>
            <if test="idCardNumber != null">id_card_number = #{idCardNumber},</if>
            <if test="faceImageUrl != null">face_image_url = #{faceImageUrl},</if>
            <if test="faceVerifyResult != null">face_verify_result = #{faceVerifyResult},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="status != null">status = #{status},</if>
            <if test="realAuthStatus != null">real_auth_status = #{realAuthStatus},</if>
            <if test="realAuthFailReason != null">real_auth_fail_reason = #{realAuthFailReason},</if>
            <if test="realAuthReviewBy != null">real_auth_review_by = #{realAuthReviewBy},</if>
            <if test="realAuthReviewTime != null">real_auth_review_time = #{realAuthReviewTime},</if>
            <if test="adminRemark != null">admin_remark = #{adminRemark},</if>
            <if test="lastActiveTime != null">last_active_time = #{lastActiveTime},</if>
            <if test="onlineStatus != null">online_status = #{onlineStatus},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        where id = #{id}
    </update>

    <update id="updateRealAuthStatus" parameterType="org.ba7lgj.ccp.common.domain.MiniUser">
        update ccp_mini_user
        <set>
            real_auth_status = #{realAuthStatus},
            real_auth_fail_reason = #{realAuthFailReason},
            real_auth_review_by = #{realAuthReviewBy},
            real_auth_review_time = #{realAuthReviewTime},
            <if test="adminRemark != null">admin_remark = #{adminRemark},</if>
            update_time = #{updateTime}
        </set>
        where id = #{id}
    </update>

    <select id="selectUserReputation" parameterType="long" resultType="org.ba7lgj.ccp.core.domain.vo.MiniUserReputationVO">
        select avg_rating, total_no_show, total_reviews
        from ccp_user_reputation
        where user_id = #{userId}
        limit 1
    </select>

    <select id="selectUserTagStats" parameterType="long" resultType="org.ba7lgj.ccp.core.domain.vo.MiniUserTagStatVO">
        select tag, tag_count as total_count
        from ccp_user_tag_stats
        where user_id = #{userId}
        order by tag_count desc
        limit 20
    </select>

    <select id="selectUserBlacklist" parameterType="long" resultType="org.ba7lgj.ccp.core.domain.vo.MiniUserBlacklistVO">
        select id, status, expire_time
        from ccp_user_blacklist
        where user_id = #{userId}
        order by create_time desc
        limit 1
    </select>

    <select id="selectEmergencyContactCount" parameterType="long" resultType="int">
        select count(1)
        from ccp_user_emergency_contact
        where user_id = #{userId}
    </select>

</mapper>
