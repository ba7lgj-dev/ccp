# 校园拼车系统概要设计文档

## 1 系统整体架构

### 1.1 分层结构
校园拼车系统采用前后端分离的分层架构，主要分为以下几层：

#### 1.1.1 前端层
- **ruoyi-ui**：基于Vue.js和Element UI开发的管理后台前端，用于平台管理员管理系统
- **微信小程序 ccp-mp-ui**：基于微信小程序框架开发的用户端应用，用于学生发布和参与拼车

#### 1.1.2 接口层
- **ccp-miniprogram**：小程序后端API，处理小程序端的请求
- **ruoyi-admin**：管理后台API，处理管理端的请求

#### 1.1.3 业务层
- **ccp-core**：核心业务逻辑层，包含所有业务模块的Service实现和共享Domain
- **ccp-common**：公共组件层，包含通用的DTO、VO、工具类等

#### 1.1.4 数据层
- **MySQL数据库**：存储系统所有数据，包括业务表（ccp_前缀）和若依框架自带表（sys_、qrtz_、gen_等）

### 1.2 模块组成
系统主要由以下模块组成：

| 模块名称 | 所属层 | 主要职责 |
|---------|-------|---------|
| ruoyi-ui | 前端层 | 管理后台前端界面 |
| ccp-mp-ui | 前端层 | 小程序用户端界面 |
| ruoyi-admin | 接口层 | 管理后台API |
| ccp-miniprogram | 接口层 | 小程序API |
| ccp-core | 业务层 | 核心业务逻辑 |
| ccp-common | 业务层 | 公共组件和工具 |
| MySQL数据库 | 数据层 | 数据存储 |

### 1.3 典型请求路径

#### 1.3.1 小程序端请求路径
```
微信小程序 → http.js → /mp/** → miniprogram Controller → ccp-core Service → Mapper → DB
```

**示例**：
1. 小程序用户点击"发布拼车"按钮
2. 调用http.js封装的请求方法，发送POST请求到/mp/trip/publish
3. 后端ccp-miniprogram模块的MpTripController接收请求
4. 调用ccp-core模块的TripService处理业务逻辑
5. 通过Mapper操作数据库，保存拼车订单
6. 返回结果给小程序前端

#### 1.3.2 后台管理端请求路径
```
ruoyi-ui → ruoyi-admin Controller → ccp-core Service → Mapper → DB
```

**示例**：
1. 管理员在后台点击"审核实名认证"按钮
2. ruoyi-ui发送POST请求到/ccp/user/real-auth/audit
3. 后端ruoyi-admin模块的UserRealAuthController接收请求
4. 调用ccp-core模块的UserRealAuthService处理审核逻辑
5. 通过Mapper更新用户认证状态
6. 返回结果给管理端前端

## 2 模块划分

### 2.1 用户与认证模块
- **模块职责**：
  - 处理小程序用户的微信登录
  - 生成和管理JWT令牌
  - 维护用户上下文信息
  - 处理用户信息的同步和更新

- **依赖的其他模块**：
  - 微信接口服务
  - JWT工具类

- **对外暴露的主要接口**：
  - `/mp/auth/login`：小程序登录
  - `/mp/user/info`：获取用户信息
  - `/mp/user/update`：更新用户信息

### 2.2 实名认证模块
- **模块职责**：
  - 处理用户实名认证申请
  - 管理实名认证状态
  - 提供后台审核接口
  - 维护实名认证历史记录

- **依赖的其他模块**：
  - 用户与认证模块
  - 审核流程模块

- **对外暴露的主要接口**：
  - `/mp/real-auth/submit`：提交实名认证申请
  - `/mp/real-auth/info`：获取实名认证信息
  - `/ccp/user/real-auth/audit`：后台审核实名认证

### 2.3 学校与校区管理模块
- **模块职责**：
  - 管理学校信息
  - 管理校区信息
  - 管理校门信息
  - 提供学校和校区的查询接口

- **依赖的其他模块**：
  - 无直接依赖

- **对外暴露的主要接口**：
  - `/mp/school/list`：获取学校列表
  - `/mp/campus/list`：获取校区列表
  - `/mp/gate/list`：获取校门列表
  - `/ccp/school/add`：后台添加学校
  - `/ccp/campus/update`：后台更新校区

### 2.4 学校认证模块
- **模块职责**：
  - 处理用户学校认证申请
  - 管理学校认证状态
  - 提供后台审核接口
  - 维护学校认证历史记录

- **依赖的其他模块**：
  - 用户与认证模块
  - 学校与校区管理模块
  - 审核流程模块

- **对外暴露的主要接口**：
  - `/mp/school-auth/submit`：提交学校认证申请
  - `/mp/school-auth/list`：获取学校认证列表
  - `/ccp/user/school-auth/audit`：后台审核学校认证

### 2.5 拼车行程模块
- **模块职责**：
  - 处理拼车发布
  - 管理拼车订单
  - 处理用户加入、退出、确认拼车
  - 管理订单状态流转
  - 处理拼车踢人操作

- **依赖的其他模块**：
  - 用户与认证模块
  - 学校与校区管理模块
  - 地点管理模块
  - 定时任务模块

- **对外暴露的主要接口**：
  - `/mp/trip/publish`：发布拼车
  - `/mp/trip/list`：获取拼车列表
  - `/mp/trip/detail`：获取拼车详情
  - `/mp/trip/join`：加入拼车
  - `/mp/trip/quit`：退出拼车
  - `/mp/trip/confirm`：确认拼车
  - `/mp/trip/kick`：踢人

### 2.6 聊天与消息模块
- **模块职责**：
  - 处理拼车聊天消息
  - 管理消息已读状态
  - 生成系统消息
  - 提供消息查询接口

- **依赖的其他模块**：
  - 拼车行程模块

- **对外暴露的主要接口**：
  - `/mp/chat/list`：获取聊天消息列表
  - `/mp/chat/send`：发送聊天消息
  - `/mp/chat/read`：标记消息已读

### 2.7 用户信誉与评价模块
- **模块职责**：
  - 管理用户信誉评分
  - 处理拼车评价
  - 统计用户爽约记录
  - 生成用户信誉报告

- **依赖的其他模块**：
  - 拼车行程模块

- **对外暴露的主要接口**：
  - `/mp/review/submit`：提交评价
  - `/mp/review/list`：获取评价列表
  - `/mp/user/reputation`：获取用户信誉

### 2.8 黑名单与风控模块
- **模块职责**：
  - 管理用户黑名单
  - 处理用户封禁和解封
  - 监控异常行为
  - 提供风控决策支持

- **依赖的其他模块**：
  - 用户与认证模块
  - 用户信誉与评价模块

- **对外暴露的主要接口**：
  - `/ccp/user/blacklist/add`：添加黑名单
  - `/ccp/user/blacklist/remove`：移除黑名单
  - `/mp/user/check-blacklist`：检查用户是否在黑名单中

### 2.9 定时任务与订单状态流转模块
- **模块职责**：
  - 定时扫描拼车订单
  - 处理订单状态流转
  - 处理超时订单
  - 发送订单状态变更通知

- **依赖的其他模块**：
  - 拼车行程模块
  - 若依框架的定时任务组件

- **主要任务**：
  - 扫描即将出发的订单，发送提醒
  - 处理超时未成团的订单
  - 更新订单状态（如招募中→待确认→已完成）

## 3 关键业务流程

### 3.1 实名认证完整流程

```
前端提交 → 后端保存 → 后台审核 → 状态变更 → 前端限制放开
```

**详细步骤**：
1. 小程序用户进入实名认证页面，填写真实姓名、身份证号等信息，并上传身份证照片
2. 点击提交按钮，将认证信息发送到后端
3. 后端验证信息格式，保存到数据库，状态设为"待审核"
4. 后台管理员在管理系统中查看待审核的实名认证申请
5. 管理员审核认证材料，点击通过或拒绝
6. 后端更新用户实名认证状态
7. 前端获取最新认证状态，根据状态放开或限制功能使用

### 3.2 学校认证完整流程

**流程与实名认证类似**：
1. 小程序用户进入学校认证页面，选择学校和校区，填写学号、姓名等信息，并上传学生证照片
2. 点击提交按钮，将认证信息发送到后端
3. 后端验证信息格式，保存到数据库，状态设为"待审核"
4. 后台管理员在管理系统中查看待审核的学校认证申请
5. 管理员审核认证材料，点击通过或拒绝
6. 后端更新用户学校认证状态
7. 前端获取最新认证状态，根据状态放开或限制功能使用

### 3.3 拼车发布与加入

**发布流程**：
1. 用户进入发布拼车页面，填写出发地、目的地、出发时间、人数等信息
2. 点击发布按钮，发送请求到后端
3. 后端校验用户是否已完成实名认证和学校认证
4. 校验出发时间和人数限制
5. 生成拼车订单，状态设为"招募中"
6. 返回发布成功信息给前端

**加入流程**：
1. 用户在拼车大厅浏览订单，选择感兴趣的订单
2. 进入订单详情页面，点击"加入拼车"按钮
3. 填写同行人数，点击确认
4. 后端校验用户是否已完成实名认证和学校认证
5. 校验订单是否仍在招募中，人数是否已满
6. 将用户添加到拼车成员列表
7. 更新订单当前人数
8. 返回加入成功信息给前端

### 3.4 订单状态流转

```
预约 → 即将出发 → 立即出发 → 成团或超时
```

**详细状态流转**：
1. **招募中（0）**：订单刚发布，等待用户加入
2. **待确认（1）**：人数已满或发起者手动确认，等待所有成员确认
3. **已确认（2）**：所有成员已确认，即将出发
4. **已完成（3）**：行程已结束
5. **已取消（4）**：订单被取消（发起人取消、成员取消或系统超时）
6. **已过期（5）**：订单超时未成团

### 3.5 行程聊天与未读消息统计

**聊天流程**：
1. 拼车成员进入聊天页面，查看历史消息
2. 发送文本消息，后端保存到数据库
3. 其他成员刷新聊天页面，获取新消息
4. 系统自动生成加入、退出、确认等系统消息

**未读消息统计**：
1. 用户发送消息后，后端在ccp_trip_chat表中插入消息记录
2. 其他成员查看消息时，后端在ccp_trip_chat_read表中记录已读状态
3. 系统通过比较ccp_trip_chat和ccp_trip_chat_read表，统计每个用户的未读消息数
4. 在订单列表和详情页显示未读消息数

### 3.6 核心认证链路设计

**核心约束**：小程序必须在"实名通过 + 至少一个学校认证通过"后才能使用拼车核心功能

**认证链路**：
1. 用户登录小程序
2. 系统检查用户实名认证状态
3. 系统检查用户学校认证状态
4. 只有当实名认证通过且至少一个学校认证通过时，才允许使用拼车核心功能
5. 否则，引导用户完成认证

**功能访问控制**：
- 未完成实名认证：无法使用任何拼车功能
- 已完成实名认证但未完成学校认证：无法使用任何拼车功能
- 已完成实名认证和至少一个学校认证：可以使用所有拼车功能

## 4 系统设计亮点

1. **前后端分离架构**：便于开发团队分工协作，提高开发效率
2. **模块化设计**：各模块职责清晰，便于维护和扩展
3. **严格的认证机制**：确保用户身份真实性，提高系统安全性
4. **完整的订单状态流转**：覆盖拼车全流程，确保用户体验
5. **实时聊天功能**：方便拼车成员沟通，提高拼车成功率
6. **用户信誉体系**：促进用户诚信行为，提高拼车质量
7. **多学校支持**：系统设计支持多学校接入，便于横向扩展
8. **基于若依框架**：利用成熟框架的优势，减少重复开发

## 5 技术选型

| 技术/框架 | 版本 | 用途 |
|----------|------|------|
| Spring Boot | 2.7.x | 后端基础框架 |
| RuoYi | 4.7.x | 管理后台框架 |
| Vue.js | 2.x | 前端框架 |
| Element UI | 2.x | 管理后台UI组件库 |
| 微信小程序框架 | 最新 | 小程序开发框架 |
| MySQL | 8.0 | 数据库 |
| MyBatis | 3.x | ORM框架 |
| JWT | - | 身份验证 |
| Maven | 3.6+ | 项目构建工具 |
| Node.js | 14+ | 前端开发环境 |
| npm | 6+ | 前端包管理工具 |