<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.ba7lgj.ccp.miniprogram.mapper.MpTripMapper">
    <resultMap id="TripResult" type="org.ba7lgj.ccp.miniprogram.domain.MpTrip">
        <id property="id" column="id" />
        <result property="schoolId" column="school_id" />
        <result property="campusId" column="campus_id" />
        <result property="ownerUserId" column="owner_user_id" />
        <result property="startGateId" column="start_gate_id" />
        <result property="startLocationId" column="start_location_id" />
        <result property="startAddress" column="start_address" />
        <result property="endGateId" column="end_gate_id" />
        <result property="endLocationId" column="end_location_id" />
        <result property="endAddress" column="end_address" />
        <result property="ownerPeopleCount" column="owner_people_count" />
        <result property="totalPeople" column="total_people" />
        <result property="currentPeople" column="current_people" />
        <result property="departureTime" column="departure_time" />
        <result property="confirmMode" column="confirm_mode" />
        <result property="confirmStartTime" column="confirm_start_time" />
        <result property="confirmedTime" column="confirmed_time" />
        <result property="requireText" column="require_text" />
        <result property="status" column="status" />
        <result property="remark" column="remark" />
        <result property="createBy" column="create_by" />
        <result property="createTime" column="create_time" />
        <result property="updateBy" column="update_by" />
        <result property="updateTime" column="update_time" />
    </resultMap>

    <insert id="insertTrip" parameterType="org.ba7lgj.ccp.miniprogram.domain.MpTrip" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ccp_trip (
            school_id,
            campus_id,
            owner_user_id,
            start_gate_id,
            start_location_id,
            start_address,
            end_gate_id,
            end_location_id,
            end_address,
            total_people,
            owner_people_count,
            current_people,
            departure_time,
            require_text,
            confirm_mode,
            status,
            create_time,
            update_time
        )
        VALUES (
            #{schoolId},
            #{campusId},
            #{ownerUserId},
            #{startGateId},
            #{startLocationId},
            #{startAddress},
            #{endGateId},
            #{endLocationId},
            #{endAddress},
            #{totalPeople},
            #{ownerPeopleCount},
            #{currentPeople},
            #{departureTime},
            #{requireText},
            #{confirmMode},
            #{status},
            NOW(),
            NOW()
        )
    </insert>

    <select id="selectHallTrips" resultMap="TripResult">
        SELECT id, school_id, campus_id, owner_user_id, start_gate_id, start_location_id, start_address, end_gate_id, end_location_id,
               end_address, owner_people_count, total_people, current_people, departure_time, confirm_mode, confirm_start_time, confirmed_time, require_text, status, remark, create_by,
               create_time, update_by, update_time
        FROM ccp_trip
        WHERE campus_id = #{campusId} AND status = 0 AND departure_time >= #{minTime}
        ORDER BY departure_time ASC
    </select>

    <select id="selectById" resultMap="TripResult">
        SELECT id, school_id, campus_id, owner_user_id, start_gate_id, start_location_id, start_address, end_gate_id, end_location_id,
               end_address, owner_people_count, total_people, current_people, departure_time, confirm_mode, confirm_start_time, confirmed_time, require_text, status, remark, create_by,
               create_time, update_by, update_time
        FROM ccp_trip
        WHERE id = #{id}
    </select>

    <update id="updateTripStatus">
        UPDATE ccp_trip
        SET status = #{status}, update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <update id="updateConfirmStart">
        UPDATE ccp_trip
        SET status = #{status}, confirm_start_time = #{confirmStartTime}, update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <update id="updateConfirmDone">
        UPDATE ccp_trip
        SET status = #{status}, confirmed_time = #{confirmedTime}, update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <update id="updateTripCurrentPeople">
        UPDATE ccp_trip
        SET current_people = #{currentPeople}, update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <select id="selectActiveTripsByUser" resultMap="TripResult">
        SELECT t.id, t.school_id, t.campus_id, t.owner_user_id, t.start_gate_id, t.start_location_id, t.start_address, t.end_gate_id,
               t.end_location_id, t.end_address, t.owner_people_count, t.total_people, t.current_people, t.departure_time,
               t.confirm_mode, t.confirm_start_time, t.confirmed_time, t.require_text, t.status, t.remark, t.create_by, t.create_time, t.update_by, t.update_time
        FROM ccp_trip t
        INNER JOIN ccp_trip_member m ON t.id = m.trip_id
        WHERE m.user_id = #{userId}
          AND m.status = 1
          AND t.status IN (0, 1, 2)
        ORDER BY t.departure_time ASC
    </select>

    <select id="countActiveTripByUser" resultType="int">
        SELECT COUNT(1)
        FROM ccp_trip t
        LEFT JOIN ccp_trip_member m ON t.id = m.trip_id AND m.user_id = #{userId} AND m.status = 1
        WHERE t.status IN (0, 1, 2)
          AND (t.owner_user_id = #{userId} OR m.user_id IS NOT NULL)
    </select>

    <select id="countActiveTripByUserExcludeTrip" resultType="int">
        SELECT COUNT(1)
        FROM ccp_trip t
        LEFT JOIN ccp_trip_member m ON t.id = m.trip_id AND m.user_id = #{userId} AND m.status = 1
        WHERE t.status IN (0, 1, 2)
          AND (t.owner_user_id = #{userId} OR m.user_id IS NOT NULL)
          AND t.id != #{tripId}
    </select>

    <select id="selectHistoryTripsByUser" resultMap="TripResult">
        SELECT t.id, t.school_id, t.campus_id, t.owner_user_id, t.start_gate_id, t.start_location_id, t.start_address,
               t.end_gate_id, t.end_location_id, t.end_address, t.owner_people_count, t.total_people, t.current_people,
               t.departure_time, t.confirm_mode, t.confirm_start_time, t.confirmed_time, t.require_text, t.status, t.remark, t.create_by, t.create_time, t.update_by, t.update_time
        FROM ccp_trip t
        INNER JOIN ccp_trip_member m ON t.id = m.trip_id
        WHERE m.user_id = #{userId}
          AND (t.status IN (3, 4, 5) OR (t.status = 2 AND t.departure_time < #{now}))
        ORDER BY t.departure_time DESC
        LIMIT #{limit}
    </select>
</mapper>
